<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/admin/assets/css/styles.min.css" />
  <link rel="stylesheet" href="/admin/assets/css/users.css" />
  
  <title>Admin Dashboard</title>
  <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-vYYV5jDJD8NZFJDbIgyxreMLHIxNYRhiCb1vhVzly31C5wIccje5MYtXCG1uLzz0" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha384-KyZXEAg3QhqLMpG8r+Knujsl7/8eSYV4RvhLtTPFl+f+8FL1T8JcfXRWlkH/2mjT" crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha384-KyZXEAg3QhqLMpG8r+Knujsl7/8eSYV4RvhLtTPFl+f+8FL1T8JcfXRWlkH/2mjT" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.7/dist/umd/popper.min.js" integrity="sha384-oBqDVmMz4fnFO9gybP6Q2jrWzz58gEtUCl6eATeU6+ICkufRYUDH+eKkPv90W0XI" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js" integrity="sha384-cn7l7gDp0eyya3o6b4k5oaw/IMWb3y1aHj0KbDhl1+0Ej4tlINk8l1e4leAM3uDI" crossorigin="anonymous"></script> -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-XXXX" crossorigin="anonymous"></script>


  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f8f9fa;
      padding: 20px;
    }

    form {
      background-color: #ffffff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      max-width: 500px;
      margin: 0 auto;
    }

    form label {
      display: block;
      font-weight: bold;
      margin-bottom: 8px;
      margin-top: 16px;
    }

    form input[type="text"],
    form select,
    form textarea {
      width: calc(100% - 22px);
      padding: 10px;
      margin-bottom: 16px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-size: 16px;
    }

    form textarea {
      resize: vertical;
    }

    form button {
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    form button[type="submit"] {
      background-color: #007bff;
      color: #ffffff;
    }

    form button[type="reset"] {
      background-color: #6c757d;
      color: #ffffff;
      margin-left: 10px;
    }

    form button[type="submit"]:hover {
      background-color: #0056b3;
    }

    form button[type="reset"]:hover {
      background-color: #5a6268;
    }



    /* modal */

    /* The Modal (background) */
    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      padding-top: 60px;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgb(0, 0, 0);
      background-color: rgba(0, 0, 0, 0.4);
    }

    /* The Modal (background) */
    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      padding-top: 60px;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgb(0, 0, 0);
      background-color: rgba(0, 0, 0, 0.4);
    }

    /* Modal Content */
    /* The Modal (background) */
    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      padding-top: 60px;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgb(0, 0, 0);
      background-color: rgba(0, 0, 0, 0.4);
    }

    /* Modal Content */
    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
    }

    /* The Close Button */
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }

    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }


    .img-preview {
      max-width: 100%;
      max-height: 300px;
      margin-top: 10px;
      display: none;
    }
  </style>
</head>
<body>
  <!-- Body Wrapper -->
  <div class="page-wrapper" id="main-wrapper" data-layout="vertical" data-navbarbg="skin6" data-sidebartype="full"
    data-sidebar-position="fixed" data-header-position="fixed">
    <!-- Sidebar Start -->
    <aside class="left-sidebar">
      <!-- Sidebar scroll-->
      <div>
        <div class="brand-logo d-flex align-items-center justify-content-between">
          <a href="./index.html" class="text-nowrap logo-img">
            <img src="/admin/assets/images/logos/dark-logo.svg" width="180" alt="" />
          </a>
          <div class="close-btn d-xl-none d-block sidebartoggler cursor-pointer" id="sidebarCollapse">
            <i class="ti ti-x fs-8"></i>
          </div>
        </div>
        <!-- Sidebar navigation-->
        <nav class="sidebar-nav scroll-sidebar" data-simplebar="">
          <ul id="sidebarnav">
            <li class="sidebar-item">
              <a class="sidebar-link" href="/admin" aria-expanded="false">
                <span></span>
                <span class="hide-menu">Dashboard</span>
              </a>
            </li>
            <li class="sidebar-item">
              <a class="sidebar-link" href="/admin/category" aria-expanded="false">
                <span></span>
                <span class="hide-menu">Category</span>
              </a>
            </li>

            <li class="sidebar-item">
              <a class="sidebar-link" href="/admin/category" aria-expanded="false">
                <span></span>
                <span class="hide-menu">Brands</span>
              </a>
            </li>


            <li class="sidebar-item">
              <a class="sidebar-link" href="/admin/products" aria-expanded="false">
                <span></span>
                <span class="hide-menu">Products</span>
              </a>
            </li>
            <li class="sidebar-item">
              <a class="sidebar-link" href="/admin/users" aria-expanded="false">
                <span></span>
                <span class="hide-menu">Users</span>
              </a>
            </li>
            <li class="sidebar-item">
              <a class="sidebar-link" href="/admin/orders" aria-expanded="false">
                <span></span>
                <span class="hide-menu">Orders</span>
              </a>
            </li>
            <li class="sidebar-item">
              <a class="sidebar-link" href="/admin/coupons" aria-expanded="false">
                <span></span>
                <span class="hide-menu">Coupon</span>
              </a>
            </li>
            <li class="sidebar-item">
              <a class="sidebar-link" href="#" aria-expanded="false">
                <span></span>
                <span class="hide-menu">Logout</span>
              </a>
            </li>
          </ul>
        </nav>
        <!-- End Sidebar navigation -->
      </div>
      <!-- End Sidebar scroll-->
    </aside>
    <!-- Sidebar End -->
    <!-- Main wrapper -->
    
<body>
  <link rel="stylesheet" href="/admin//assets/css/styles.min.css" />
<!--  Body Wrapper -->
<div class="page-wrapper" id="main-wrapper" data-layout="vertical" data-navbarbg="skin6" data-sidebartype="full"
  data-sidebar-position="fixed" data-header-position="fixed">
  <!-- Sidebar Start -->
  <aside class="left-sidebar">
    <!-- Sidebar scroll-->
    <div>
      <div class="brand-logo d-flex align-items-center justify-content-between">
        <a href="./index.html" class="text-nowrap logo-img">
          <img src="/admin/assets/images/logos/dark-logo.svg" width="180" alt="" />
        </a>
        <div class="close-btn d-xl-none d-block sidebartoggler cursor-pointer" id="sidebarCollapse">
          <i class="ti ti-x fs-8"></i>
        </div>
      </div>
      <!-- Sidebar navigation-->
      <nav class="sidebar-nav scroll-sidebar" data-simplebar="">
        <ul id="sidebarnav">
          <li class="sidebar-item">
            <a class="sidebar-link" href="/admin" aria-expanded="false">
              <span></span>
              <span class="hide-menu">Dashboard</span>
            </a>
          </li>
          <li class="sidebar-item">
            <a class="sidebar-link" href="/admin/category" aria-expanded="false">
              <span></span>
              <span class="hide-menu">Category</span>
            </a>
          </li>

          <li class="sidebar-item">
            <a class="sidebar-link" href="/admin/brands"
              aria-expanded="false">
              <span></span>
              <span class="hide-menu">Brands</span>
            </a>
          </li>

          <li class="sidebar-item">
            <a class="sidebar-link" href="/admin/products" aria-expanded="false">
              <span></span>
              <span class="hide-menu">Products</span>
            </a>
          </li>

          <li class="sidebar-item">
            <a class="sidebar-link" href="/admin/products/colors" aria-expanded="false">
              <span></span>
              <span class="hide-menu">colors</span>
            </a>
          </li>

          <li class="sidebar-item">
            <a class="sidebar-link" href="/admin/products/sizes" aria-expanded="false">
              <span></span>
              <span class="hide-menu">sizes</span>
            </a>
          </li>
          <li class="sidebar-item">
            <a class="sidebar-link" href="/admin/users" aria-expanded="false">
              <span></span>
              <span class="hide-menu">Users</span>
            </a>
          </li>
          <li class="sidebar-item">
            <a class="sidebar-link" href="/admin/orders" aria-expanded="false">
              <span></span>
              <span class="hide-menu">Orders</span>
            </a>
          </li>
          <li class="sidebar-item">
            <a class="sidebar-link" href="/admin/coupons" aria-expanded="false">
              <span></span>
              <span class="hide-menu">Coupon</span>
            </a>
          </li>
          <li class="sidebar-item">
            <a class="sidebar-link" href="/admin/offers" aria-expanded="false">
              <span></span>
              <span class="hide-menu">Offer</span>
            </a>
          </li>
          <li class="sidebar-item">
            <a class="sidebar-link" href="/admin/salesreport" aria-expanded="false">
              <span></span>
              <span class="hide-menu">Sales Report</span>
            </a>
          </li>
          <li class="sidebar-item">
            <a class="sidebar-link" href="/admin/logout" aria-expanded="false">
              <span></span>
              <span class="hide-menu"  id="logout-link"  >Logout</span>
            </a>
          </li>
        </ul>
      </nav>
      <!-- End Sidebar navigation -->
    </div>
    <!-- End Sidebar scroll-->
  </aside>
  <!--  Sidebar End -->
  <!--  Main wrapper -->

  
<!-- table -->

<div class="col-lg-8 d-flex align-items-stretch main">
    <div class="card w-100">
      <div class="card-body p-4 ">
        <div class="button w-100 d-flex  justify-content-end">
          <%if(variant){%>
            <!-- <a style="margin-right: 10px; width: 200px;"  onclick="sendPId('<%= variant[0].productId %>')" class="btn btn-primary">Add variants</a> -->

            <!-- <button class="btn btn-primary"  style="margin-right: 10px; width: 200px;"  type="submit" onclick="sendPId('<%= variant[0].productId %>','<%= variant[0].categoryName %>')" id="addProductBtn" data-toggle="modal"
            data-target="#exampleModal">Add variants </button> -->
<!-- 
            
            <p id="category" value="<%= variant[0].categoryName %> "></p> -->
          <a style="width: 200px;" href="/admin/products/unlistvariant" class="btn btn-danger">Removed Variants</a>
      </div>
      <h5 class="card-title fw-semibold mb-4" id="table">Product Details</h5>
      
        <h5 class="card-title  mb-4" id="table"><%=variant[0].products[0].productName %></h5>
            <div>
              <%=variant[0].products[0].description %>
            </div>
      <div class="table-responsive">
        <table class="table text-nowrap mb-0 align-middle">
          <thead class="text-dark fs-4">
            <tr>
                <th class="border-bottom-0"><h6 class="fw-semibold mb-0"> Image</h6></th>
                <th class="border-bottom-0"><h6 class="fw-semibold mb-0">Price</h6></th>
                <th class="border-bottom-0"><h6 class="fw-semibold mb-0">color</h6></th>
                <th class="border-bottom-0"><h6 class="fw-semibold mb-0">Edit</h6></th>
                <th class="border-bottom-0"><h6 class="fw-semibold mb-0">Unlist</h6></th>
                <!-- <th class="border-bottom-0"><h6 class="fw-semibold mb-0">Status</h6></th> -->
              
              </tr>
          </thead>
          <tbody>
              <%variant.forEach((variant)=>{%>

                <tr id="<%=variant._id%>">
                  <td class="border-bottom-0">
                    <img src="<%= variant.images[0] %>" alt="" width="100px" height="100px"> <!-- product.variants[0].images[0]-->
                  </td>
                  <td class="border-bottom-0">
                    <p class="mb-0 fw-normal"><%=variant.price%></p>    <!--product.variants.length-->
                  </td>

                  <td class="border-bottom-0">
                    <div class="d-flex align-items-center gap-2">
                      <p class="mb-0 fw-normal"><%=variant.colors%></p>
                    </div>
                  </td>

                  <td class="border-bottom-0 ">
                    <div class="d-flex align-items-center gap-2">
                      <a href="/admin/products/editvariants?vId=<%=variant._id%>"><button href="" class="badge bg-primary rounded-3 fw-semibold">Edit</button>  </a>  
                    </div>

                  </td>
                 
                  <td class="border-bottom-0 ">
                    <div class="d-flex align-items-center gap-2">
                        <button onclick="unlistVariant('<%=variant._id%>')" class="badge bg-danger rounded-3 fw-semibold">unlist</button>
                    </div>

                  </td>
                </tr>
             <% })%>

              <%}%>
          
            
             
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
</div>




    <!-- modal 1 -->
    <div class="modal fade" id="variantModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
            <p id="demo"></p>
            <button type="button" onclick="deleteData()" class="btn-close" data-bs-dismiss="modal" id="close_btn" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="variantForm"  enctype="multipart/form-data">
              <!-- Color -->
              <label for="color">Color:</label>
              <select id="color" name="color" required>
                  <option value="">Select a color</option>
                  <% if (colors) { %>
                      <% colors.forEach((col) =>{ %>
                          <option value="<%= col.color_name %>"><%= col.color_name%></option>       <!-- -->
                      <% }); %>
                  <% } %>
              </select>
              <!-- hidden-->


              <label for="price">Price:</label>
              <input type="number" id="price" name="price" value="" required>
              <label for="stock" id="stock">Stock:</label>
              <% if (sizes && sizes.length > 0) { %>
                  <input type="hidden" name="" id="size_length" value=<%= sizes.length %>>
                  <% sizes.forEach((size, index) => { %>
                    <div>
                      <input type="text" id="size<%= index %>" value="<%= size.sizeName %>" placeholder="<%= size.sizeName %>" readonly>
                      <br>
                      <input type="number" placeholder="Quantity" id="quantity<%= index %>" required>
                    </div>
                  <% }); %>
              <% } %>
            
              <!-- Image Upload and Crop -->
              <div class="form-group">
                <label for="image1">Image 1:</label>
                <input type="file" class="form-control" id="image1" name="image1" accept="image/*" onchange="showCropper(event, 'imagePreview1', 'cropBtn1')">
                <img id="imagePreview1" class="img-preview" src="" alt="Image Preview 1">
                <button type="button" id="cropBtn1" style="display:none;" onclick="cropImage('image1', 'imagePreview1')">Crop</button>
              </div>
              <div class="form-group">
                <label for="image2">Image 2:</label>
                <input type="file" class="form-control" id="image2" name="image2" accept="image/*" onchange="showCropper(event, 'imagePreview2', 'cropBtn2')">
                <img id="imagePreview2" class="img-preview" src="" alt="Image Preview 2">
                <button type="button" id="cropBtn2" style="display:none;" onclick="cropImage('image2', 'imagePreview2')">Crop</button>
              </div>
              <div class="form-group">
                <label for="image3">Image 3:</label>
                <input type="file" class="form-control" id="image3" name="image3" accept="image/*" onchange="showCropper(event, 'imagePreview3', 'cropBtn3')">
                <img id="imagePreview3" class="img-preview" src="" alt="Image Preview 3">
                <button type="button" id="cropBtn3" style="display:none;" onclick="cropImage('image3', 'imagePreview3')">Crop</button>
              </div>
              <div id="errP" style="color: red;"></div>
              <div class="modal-footer">
                <button type="submit" aria-label="Close" id="close-btn" class="btn btn-primary">Save Variant</button>
              </div>
            </form>
            <input type="text" name="productId" id="productId" hidden> 
            <input type="text" name="category" id="category" hidden>    
           
          </div>
        </div>

      </div>


    </div>

    
<!-- <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDuWojXrFEMFq/gzBN+gy2RfuFga5oM4RT0zVdPs4NsWu0nU4" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js" integrity="sha384-+YQ4b54N6j9ocqPSFneN8FbB5gODwSTxM8zwXjwU2A/dBg2x+0GTn5FwF86dIHND" crossorigin="anonymous"></script> -->


  <!-- cropper -->
  <script src="https://unpkg.com/cropperjs"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.7.2/axios.min.js" integrity="sha512-JSCFHhKDilTRRXe9ak/FJ28dcpOJxzQaCd3Xg8MyF6XFjODhy/YMCM8HW0TFDckNHWUewW+kfvhin43hKtJxAw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script src="../assets/libs/jquery/dist/jquery.min.js"></script>
<script src="../assets/libs/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
<script src="../assets/js/sidebarmenu.js"></script>
<script src="../assets/js/app.min.js"></script>
<script src="../assets/libs/apexcharts/dist/apexcharts.min.js"></script>
<script src="../assets/libs/simplebar/dist/simplebar.js"></script>
<script src="../assets/js/dashboard.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/axios@1.6.7/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/axios@1.6.7/dist/axios.min.js"></script>

<script>
  function unlistVariant(pId){
 
    let row = document.getElementById(pId)
    row.addEventListener('click',(e)=>{
      Swal.fire({
          title: "You want to unlist this product?",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#3085d6",
          cancelButtonColor: "#d33",
          confirmButtonText: "unlist this product"
        }).then((result) => {
          if (result.isConfirmed) {
            Swal.fire({
              title: "unlisted!",
              text: "Your can change this",
              icon: "success"
            });
            axios.post(`/admin/products/unlistvariant/?pId=${pId}`).then((response) => {
              if (response.status == 200) {
                  const row = document.getElementById(pId);
                  if (row) {
                      row.parentNode.removeChild(row); 
                  }
              }
          });
          
          }
        });
    })
  }




  document.getElementById('variantForm').addEventListener('submit', function(event) {
      event.preventDefault();
      addVariant(event);
    });

    let globalProductId;
    let globalCategoryName;

    function sendPId(productId,categoryName) {
      globalProductId = productId;
      globalCategoryName = categoryName;
    document.getElementById('productId').value = productId;
    document.getElementById('category' ).value = categoryName;

    console.log("Product ID set to:", productId);
    console.log(categoryName,'categoryName');
    
    $('#variantModal').modal('show');


}




    // new cropper added

  
    function showCropper(event, previewId, cropBtnId) {
        const reader = new FileReader();
        reader.onload = function() {
          const output = document.getElementById(previewId);
          output.src = reader.result;
          output.style.display = 'block';
          const cropBtn = document.getElementById(cropBtnId);
          cropBtn.style.display = 'block';

          if (window.cropper) {
            window.cropper.destroy();
          }

          window.cropper = new Cropper(output, {
            aspectRatio: 1,
            viewMode: 1,
            autoCropArea: 1
          });
        };
        reader.readAsDataURL(event.target.files[0]);
      }

      function cropImage(inputId, previewId) {
        const canvas = window.cropper.getCroppedCanvas({
          width: 600,
          height: 600
        });

        const croppedImage = canvas.toDataURL('image/jpeg',1);
        const inputElement = document.getElementById(inputId);
        inputElement.dataset.cropped = croppedImage;
        document.getElementById(previewId).src = croppedImage;

        window.cropper.destroy();
      }


// end of cropper side



document.getElementById('variantForm').addEventListener('submit', function(event) {
    event.preventDefault(); // Prevent the default form submission
    addVariant(event); // Call the addVariant function
});

async function addVariant(event) {
    const formData = new FormData();
    const variantData = {};

    const productIdElement = document.getElementById("productId");
    const categoryElement = document.getElementById('category')
    if (!productIdElement) {
        console.error("Product ID element not found");
        return;
    }
    formData.append("pId", productIdElement.value);
    variantData['pId'] = productIdElement.value;
    formData.append('cName',categoryElement.value);
    variantData['cName'] = categoryElement.value;
    console.log('categoryElement.value');
 

    console.log('globalCategoryName',globalCategoryName);
    
    

    const colorElement = document.getElementById("color");
    if (!colorElement) {
        console.error("Color element not found");
        return;
    }
    formData.append("color", colorElement.value);
    variantData['color'] = colorElement.value;

    const priceElement = document.getElementById("price");
    if (!priceElement) {
        console.error("Price element not found");
        return;
    }
    formData.append("price", priceElement.value);
    variantData['price'] = priceElement.value;

    const sizeLengthElement = document.getElementById("size_length");
    if (!sizeLengthElement) {
        console.error("Size length element not found");
        return;
    }
    const sizes = parseInt(sizeLengthElement.value, 10);
    const stock = [];

    for (let i = 0; i < sizes; i++) {
        const sizeElement = document.getElementById("size" + i);
        const quantityElement = document.getElementById("quantity" + i);

        if (!sizeElement || !quantityElement) {
            console.error(`Size or quantity element not found for index ${i}`);
            continue;
        }

        stock.push({
            size: sizeElement.value,
            quantity: parseInt(quantityElement.value, 10)
        });
    }

    formData.append("stock", JSON.stringify(stock));
    variantData['stock'] = stock;
    console.log(stock,'stock');
    

    const imageInputs = ['image1', 'image2', 'image3'];
    const croppedImages = [];

    for (const id of imageInputs) {
        const inputElement = document.getElementById(id);
        if (!inputElement) {
            console.error(`Image element not found for ${id}`);
            continue;
        }
        if (inputElement.dataset.cropped) {
            const blob = dataURLtoBlob(inputElement.dataset.cropped);
            const fileObject = new File([blob], `image.jpg`, { type: blob.type });
            const base64 = await convertToBase64(fileObject);
            croppedImages.push(base64);
        } else if (inputElement.files[0]) {
            const base64 = await convertToBase64(inputElement.files[0]);
            croppedImages.push(base64);
        }
    }

    variantData['images'] = croppedImages;

    try {
        const response = await axios.post('/admin/products/addproductvariant', variantData);
        const data = await response.data;

        if (data.type === "error") {
            showSnackBar(data.msg);
        } else {
            variantAlert(); // Trigger the Swal alert
        }
    } catch (err) {
        console.log(err);
        document.getElementById("errP").innerHTML = "Network Error";
    }
}


    function resetForms() {
  // Select all forms within the modal and reset them
  $('#variantModal form').each(function() {
    this.reset();


  })

  // Reset the preview elements
 
  $('#imagePreview1').innerHTML= " "; 
  $('#imagePreview2').innerHTML= " ";
  $('#imagePreview3').innerHTML= " ";
  $('#imagePreview1').attr('src', '');
  $('#imagePreview2').attr('src', '');
  $('#imagePreview3').attr('src', '');
 
}




    async function addVariant (event){
      event.preventDefault()
      const formData = new FormData()
    
    
      formData.append("pId",document.getElementById("productId").value)     //key value pair
      formData.append("color",document.getElementById("color").value)
      formData.append("price",document.getElementById("price").value)
    
      const sizes = document.getElementById("size_length").value
      const stock = []
    
      for(let i=0; i<sizes ;i++){
        const size = document.getElementById("size" + i).value
        const quantity = parseInt(document.getElementById("quantity" +i).value)
    
          stock.push({
            size:size,                                    
            quantity:quantity
          })
          
      }
    
      console.log(stock);
      
    // Convert stock array to JSON string
      formData.append("stock",JSON.stringify(stock))                                                               // stock



      const imageInputs = ['image1', 'image2', 'image3'];
        imageInputs.forEach((imageId, index) => {
          const inputElement = document.getElementById(imageId);
          if (inputElement.dataset.cropped) {
            const blob = dataURLtoBlob(inputElement.dataset.cropped);
            formData.append(`image${index + 1}`, blob, `image${index + 1}.jpg`);
          } else if (inputElement.files[0]) {
            formData.append(`image${index + 1}`, inputElement.files[0]);
          }
        });                            
      
    
    $("#variantModal").modal('hide') 
    
    
    try{
  const resp = await fetch("/admin/products/addproductvariant",{
    method: "POST",
    body:formData
  })

  const data = await resp.json()

  if(data.type === "error"){
    document.getElementById("errP").innerHTML = data.msg
    document.getElementById("ok_button").setAttribute("onClick","getVariantModal()")
    const myModal = new boostrap.Modal(document.getElementById("message"))


  }else{
    const proId = document.getElementById("productId")
    document.getElementById("close-btn").removeAttribute("onclick",`deleteData(${proId})`)
    document.getElementById("close_btn".setAttribute("onclick", `clearAllForm()`))
    // document.getElementById("close_btn".setAttribute("onclick", `clearAllForm()`))
    // document.getElementById("close_btn".setAttribute("onclick", `clearAllForm()`))
    // document.getElementById("close_btn".setAttribute("onclick", `clearAllForm()`))

  }
  
}catch(err){

  document.getElementById("errP").innerHTML = "Network Error"

}


}



function dataURLtoBlob(dataURL) {
        const arr = dataURL.split(',');
        const mime = arr[0].match(/:(.*?);/)[1];
        const bstr = atob(arr[1]);
        let n = bstr.length;
        const u8arr = new Uint8Array(n);
        while (n--) {
          u8arr[n] = bstr.charCodeAt(n);
        }
        return new Blob([u8arr], { type: mime });
      }
     
</script>



<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.getElementById('logout-link').addEventListener('click', function(event) {
    event.preventDefault();
    Swal.fire({
        title: 'Do you want to logout?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, logout',
        cancelButtonText: 'No, stay logged in'
    }).then((result) => {
        if (result.isConfirmed) {
            window.location.href = '/admin/logout';
        }
    });
});
</script>


</body>